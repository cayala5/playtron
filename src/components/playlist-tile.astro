---
import { Image } from "astro:assets";
import defaultPlaylistImage from "../images/default_playlist.png";
interface Props {
    name: string;
    tracks: number;
    imageSrc: string;
    plId: string;
    paging?: {
        trigger: string;
        nextReq: string;
    }
}

const { name, tracks, plId, paging, imageSrc } = Astro.props;
---

<script>
    // CHRISTIAN: this isn't getting sent now because we're using htmx partials
    const tiles = document.querySelectorAll("div.playlist-tile");

    async function makePutRequest(plId: string) {
        const resp = await fetch("/playlists/" + plId, {
            method: "PUT",
            body: JSON.stringify({ action: "shuffle" }),
        });
        return resp.ok;
    }

    tiles.forEach((elem) => {
        const tile = elem as HTMLDivElement;
        const plId = tile.dataset.plId;
        const name = tile.dataset.name;
        if (!plId || !name) {
            return;
        }

        tile.addEventListener("click", async () => {
            const success = await makePutRequest(plId);
            const alertMsg = success
                ? `Playlist ${name} shuffled successfully`
                : `Error while shuffling playlist ${name}`;
            alert(alertMsg);
        });
    });
</script>

<div
    class="root card playlist-tile"
    data-pl-id={plId}
    data-name={name}
    hx-get={paging?.nextReq}
    hx-swap={paging ? "afterend": undefined}
    hx-trigger={paging?.trigger}
>
{/* CHRISTIAN: why does ts hate this? */}
    <Image
        src={imageSrc || defaultPlaylistImage}
        alt=`Cover of playlist "${name}"`
        height={100}
        width={100}
    />
    <div class="text-area">
        <span>{name}</span>
        <br />
        <span>{`${tracks} tracks`}</span>
    </div>
</div>
