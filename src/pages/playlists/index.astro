---
import PlaylistTile from "../../components/playlist-tile.astro";
import { SpotifyAPIHelper } from "../../script/spotify_api";

export const partial = true;

const token = Astro.cookies.get("session")?.value;
if (token === undefined) {
    return Astro.redirect("/auth");
}

const params = Astro.url.searchParams;
const limit = params.has("limit") ? parseInt(params.get("limit")!) : undefined;
const offset = params.has("offset") ? parseInt(params.get("offset")!) : undefined;

const spotify = new SpotifyAPIHelper(token);
const plData = await spotify.makeCurrentUserPlaylistRequest(offset, limit);
if (!spotify.validateMePlaylistsResponse(plData)) {
    console.log("Request to /me/playlists failed to return the right data");
    return Astro.redirect("/error");
}

const numItems = plData.items.length;
const allButLast = plData.items.slice(0, numItems - 1);
const last = plData.items[numItems-1];
---

{
    plData.items.map((pl, i) => (
        <PlaylistTile
            name={pl.name}
            tracks={pl.tracks.total}
            imageSrc={pl.images[0].url}
            plId={pl.id}
            hx-get={i == numItems - 1 ? "load" : null}
        />
    ))
}